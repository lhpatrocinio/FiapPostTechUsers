# FiapPostTechUsers - Microservi√ßo de Usu√°rios

Microservi√ßo de gerenciamento de usu√°rios e autentica√ß√£o com **observabilidade completa** implementando:
- üë§ **Gest√£o de Usu√°rios**: CRUD completo com valida√ß√µes e autentica√ß√£o
- üìä **Distributed Tracing**: OpenTelemetry + Jaeger para rastreamento distribu√≠do
- üìà **Monitoramento**: Prometheus + Grafana + ELK Stack
- üöÄ **Infraestrutura**: Docker containerizado com health checks

## üéØ **Como o Microservi√ßo Users est√° Funcionando**

O sistema utiliza arquitetura limpa para:
- **üë§ Autentica√ß√£o**: JWT tokens com refresh token support
- **üîê Autoriza√ß√£o**: Role-based access control (RBAC)
- **üìù Valida√ß√µes**: FluentValidation para regras de neg√≥cio
- **üîÑ Event Sourcing**: Eventos publicados via RabbitMQ
- **‚ö° Performance**: Entity Framework com otimiza√ß√µes

### **üèóÔ∏è Arquitetura do Microservi√ßo**
- **Domain Layer**: Entidades, enums e regras de neg√≥cio
- **Application Layer**: Servi√ßos, DTOs, valida√ß√µes e mappers
- **Infrastructure Layer**: Reposit√≥rios, banco de dados e integra√ß√µes
- **API Layer**: Controllers, middleware e configura√ß√µes
- **Event Integration**: RabbitMQ para comunica√ß√£o ass√≠ncrona
- **Observabilidade**: OpenTelemetry integration completa

### **üîç Observabilidade & Distributed Tracing**
- **OpenTelemetry**: Instrumenta√ß√£o autom√°tica de HTTP requests e ASP.NET Core
- **Jaeger**: Visualiza√ß√£o de traces distribu√≠dos na porta 16686
- **Service Name**: "Users.Api" para identifica√ß√£o no tracing
- **Trace Correlation**: Correla√ß√£o autom√°tica entre microservi√ßos
- **Performance Monitoring**: Medi√ß√£o de lat√™ncia e identifica√ß√£o de gargalos
- **Event Tracing**: Rastreamento de eventos RabbitMQ

## üöÄ **Como Iniciar**

### **1. Pr√©-requisitos**
```bash
# Ferramentas necess√°rias
- Docker Desktop
- .NET 8 SDK
- Git
```

### **2. Infraestrutura (Docker)**
```bash
# 1. Navegar para o diret√≥rio de infraestrutura
cd ../FiapPostTechDocker

# 2. Subir infraestrutura completa
docker-compose up -d sqlserver elasticsearch kibana logstash prometheus grafana jaeger rabbitmq

# 3. Verificar containers rodando
docker ps
# Deve mostrar: sqlserver (1433), elasticsearch (9200), jaeger (16686), prometheus (9090), etc.

# 4. Testar servi√ßos principais
curl http://localhost:9200     # Elasticsearch
curl http://localhost:16686    # Jaeger UI
curl http://localhost:9090     # Prometheus
curl http://localhost:3000     # Grafana
```

### **3. Aplica√ß√£o (.NET)**
```bash
# 1. Navegar para a API
cd src/Users.Api

# 2. Restaurar pacotes
dotnet restore

# 3. Executar aplica√ß√£o
dotnet run
# Aplica√ß√£o dispon√≠vel em: http://localhost:5000
# Swagger dispon√≠vel em: http://localhost:5000/swagger
```

### **4. Inicializa√ß√£o Autom√°tica**
A aplica√ß√£o faz automaticamente:
- ‚úÖ **Aplica√ß√£o de migrations**: DatabaseStructure + seed data
- ‚úÖ **Configura√ß√£o JWT**: Keys e valida√ß√£o autom√°tica
- ‚úÖ **Setup RabbitMQ**: Queues e exchanges configurados
- ‚úÖ **Health checks**: Monitoramento de SQL Server + RabbitMQ

## üîê **Sistema de Autentica√ß√£o**

### **Registro de Usu√°rio**
```http
POST /api/v1/users/register
```
**Fun√ß√£o**: Registra novo usu√°rio no sistema com valida√ß√µes completas.
**Valida√ß√µes**: Email √∫nico, senha forte, dados obrigat√≥rios.
**Eventos**: Publica UserCreated via RabbitMQ para outros microservi√ßos.

### **Login de Usu√°rio**
```http
POST /api/v1/users/login
```
**Fun√ß√£o**: Autentica usu√°rio e retorna JWT token + refresh token.
**Response**: Access token (15min) + Refresh token (7 dias).
**Seguran√ßa**: Hash bcrypt para senhas.

### **Refresh Token**
```http
POST /api/v1/users/refresh
```
**Fun√ß√£o**: Renova access token usando refresh token v√°lido.
**Rota√ß√£o**: Refresh token √© rotacionado a cada uso.

### **Logout**
```http
POST /api/v1/users/logout
```
**Fun√ß√£o**: Invalida refresh token no servidor.
**Seguran√ßa**: Blacklist de tokens comprometidos.

## üë§ **Gest√£o de Usu√°rios**

### **Perfil do Usu√°rio**
```http
GET /api/v1/users/profile
```
**Fun√ß√£o**: Retorna dados do perfil do usu√°rio autenticado.
**Autoriza√ß√£o**: Requer JWT token v√°lido.

### **Atualizar Perfil**
```http
PUT /api/v1/users/profile
```
**Fun√ß√£o**: Atualiza dados do perfil (nome, email, etc.).
**Valida√ß√µes**: Email √∫nico se alterado, dados obrigat√≥rios.

### **Alterar Senha**
```http
PUT /api/v1/users/change-password
```
**Fun√ß√£o**: Permite altera√ß√£o de senha com valida√ß√£o da senha atual.
**Seguran√ßa**: Valida√ß√£o da senha atual + nova senha forte.

### **Listar Usu√°rios (Admin)**
```http
GET /api/v1/users
```
**Fun√ß√£o**: Lista usu√°rios com pagina√ß√£o (apenas administradores).
**Autoriza√ß√£o**: Requer role Admin.

## üìä **Eventos e Integra√ß√µes**

### **Eventos Publicados**
- **UserCreated**: Quando usu√°rio se registra
- **UserUpdated**: Quando perfil √© atualizado
- **UserLoggedIn**: Quando usu√°rio faz login

### **Consumidores de Eventos**
O microservi√ßo consome eventos de outros servi√ßos para:
- Sincroniza√ß√£o de dados
- Auditoria de a√ß√µes
- Notifica√ß√µes

## ‚öôÔ∏è **Caracter√≠sticas T√©cnicas**

### **üéØ Arquitetura**
- **Clean Architecture**: Separa√ß√£o clara de responsabilidades
- **CQRS Pattern**: Command/Query separation para opera√ß√µes
- **Repository Pattern**: Abstra√ß√£o do acesso a dados
- **Unit of Work**: Transa√ß√µes consistentes
- **AutoMapper**: Mapeamento autom√°tico entre DTOs e entidades

### **üîê Seguran√ßa**
- **JWT Authentication**: Tokens stateless com claims
- **Role-based Authorization**: Controle granular de acesso
- **Password Hashing**: Bcrypt com salt autom√°tico
- **Token Rotation**: Refresh tokens com rota√ß√£o
- **CORS Policy**: Configura√ß√£o segura para frontend

### **üìä Valida√ß√µes e DTOs**
- **FluentValidation**: Valida√ß√µes complexas e customizadas
- **Request DTOs**: Entrada de dados validada
- **Response DTOs**: Sa√≠da controlada sem exposi√ß√£o de dados internos
- **Error Handling**: Middleware global para tratamento de exce√ß√µes

## üîç **Monitoramento e Observabilidade**

### **Health Checks e Observabilidade**
- **`/health`**: Status geral da aplica√ß√£o + depend√™ncias
- **`/health/ready`**: Verifica√ß√£o espec√≠fica de conectividade
- **`/health/live`**: Liveness probe para containers
- **`/metrics`**: M√©tricas Prometheus para observabilidade

### **üîç Distributed Tracing Endpoints**
- **Jaeger UI**: `http://localhost:16686` - Visualiza√ß√£o de traces
- **Service Name**: "Users.Api" - Identifica√ß√£o no Jaeger
- **Trace Correlation**: Autom√°tica em todas as HTTP requests
- **Custom Spans**: Implementados para opera√ß√µes cr√≠ticas de autentica√ß√£o

### **üìä Dashboards de Monitoramento**
- **Grafana**: `http://localhost:3000` (admin/admin)
- **Prometheus**: `http://localhost:9090` - M√©tricas coletadas
- **Kibana**: `http://localhost:5601` - Logs centralizados
- **RabbitMQ**: `http://localhost:15672` (guest/guest)

### **üìù Logs Estruturados**
O sistema gera logs estruturados para:
- **Autentica√ß√£o**: Login, logout, falhas de autentica√ß√£o
- **Opera√ß√µes CRUD**: Cria√ß√£o, atualiza√ß√£o de usu√°rios
- **Eventos**: Publica√ß√£o e consumo via RabbitMQ
- **Performance**: Tempo de resposta das opera√ß√µes

## üîß **Configura√ß√£o e Deploy**

### **Vari√°veis de Ambiente**
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "SQL Server connection"
  },
  "JwtSettings": {
    "SecretKey": "your-secret-key",
    "Issuer": "Users.Api",
    "Audience": "Users.Api",
    "ExpirationMinutes": 15
  },
  "RabbitMQ": {
    "ConnectionString": "amqp://guest:guest@rabbitmq:5672/"
  }
}
```

### **Docker Setup**
```yaml
users.api:
  image: usersapi
  container_name: FiapUsers
  ports: ["5000:80"]
  networks: [postech-network]
  depends_on: [sqlserver, rabbitmq]
```

## üß™ **Verifica√ß√£o de Funcionamento**

### **Testando os Endpoints**

**Swagger UI**: Acesse `http://localhost:5000/swagger` para testar todos os endpoints interativamente.

**Principais Testes**:
- **Registro**: `POST /api/v1/users/register` com dados v√°lidos
- **Login**: `POST /api/v1/users/login` com credenciais
- **Perfil**: `GET /api/v1/users/profile` com JWT token
- **Health**: `GET /health` para verificar status

### **Teste de Autentica√ß√£o Completo**
```bash
# 1. Registrar usu√°rio
curl -X POST http://localhost:5000/api/v1/users/register \
  -H "Content-Type: application/json" \
  -d '{"name":"Test User","email":"test@example.com","password":"Test123!"}'

# 2. Fazer login
curl -X POST http://localhost:5000/api/v1/users/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test123!"}'

# 3. Usar token retornado para acessar perfil
curl -X GET http://localhost:5000/api/v1/users/profile \
  -H "Authorization: Bearer {seu-jwt-token}"
```

## üö® **Troubleshooting Completo**

### **Problemas de Autentica√ß√£o**

**JWT Token inv√°lido**:
1. Verificar se token n√£o expirou
2. Validar formato do header: `Authorization: Bearer {token}`
3. Verificar configura√ß√£o JwtSettings no appsettings.json

**Problemas de Registro**:
1. Verificar se email j√° existe
2. Validar for√ßa da senha (m√≠nimo 8 caracteres, mai√∫scula, n√∫mero, s√≠mbolo)
3. Verificar conectividade com SQL Server

### **Problemas de Infraestrutura**

**RabbitMQ n√£o conecta**:
1. Verificar container: `docker ps | grep rabbitmq`
2. Testar conectividade: `curl http://localhost:15672`
3. Verificar logs: `docker logs rabbitmq`

**Traces n√£o aparecem no Jaeger**:
1. Verificar Jaeger: `curl http://localhost:16686`
2. Verificar configura√ß√£o OpenTelemetry nos logs da aplica√ß√£o
3. Fazer requests para gerar traces

## ‚úÖ **Requisitos FIAP Tech Challenge Atendidos**

### **Gest√£o de Usu√°rios - 100% Implementado**
- ‚úÖ **CRUD Completo**: Registro, atualiza√ß√£o, consulta de usu√°rios
- ‚úÖ **Autentica√ß√£o JWT**: Login/logout com tokens seguros
- ‚úÖ **Autoriza√ß√£o RBAC**: Controle de acesso baseado em roles
- ‚úÖ **Valida√ß√µes**: FluentValidation para regras de neg√≥cio

### **Distributed Tracing - 100% Implementado**
- ‚úÖ **OpenTelemetry**: Instrumenta√ß√£o autom√°tica completa
- ‚úÖ **Jaeger**: Coleta e visualiza√ß√£o de traces distribu√≠dos
- ‚úÖ **Service Correlation**: Rastreamento entre microservi√ßos
- ‚úÖ **Performance Monitoring**: Identifica√ß√£o de gargalos

### **Funcionalidades Extras Implementadas**
- üîê **Seguran√ßa Avan√ßada**: Hash bcrypt, token rotation, CORS
- üìä **Observabilidade Completa**: ELK + Prometheus + Grafana + Jaeger
- üîÑ **Event Sourcing**: RabbitMQ para comunica√ß√£o ass√≠ncrona
- ‚öôÔ∏è **Clean Architecture**: C√≥digo limpo e test√°vel
- üöÄ **Performance**: Opera√ß√µes otimizadas com monitoramento

## üë• **Ecossistema FIAP Tech Challenge**

Este projeto faz parte da arquitetura de microservi√ßos:
- **üë§ FiapPosTechUsers**: Microservi√ßo de usu√°rios e autentica√ß√£o (este projeto)
- **üéÆ FiapPosTechGames**: Microservi√ßo de jogos com Elasticsearch
- **üí≥ FiapPosTechPayments**: Microservi√ßo de pagamentos
- **üöÄ FiapPosTechDocker**: Infraestrutura Docker compartilhada

## üìÑ **Documenta√ß√£o T√©cnica**

- **Swagger API**: `http://localhost:5000/swagger` (durante execu√ß√£o)
- **Arquitetura**: Clean Architecture com CQRS
- **Padr√µes**: Repository, Unit of Work, AutoMapper

---

**üéÜ Microservi√ßo Users com observabilidade completa em produ√ß√£o:**
- **Autentica√ß√£o JWT** robusta e segura
- **Distributed Tracing** com OpenTelemetry + Jaeger
- **Monitoramento completo** com Prometheus + Grafana + ELK Stack
- **Health checks** em todos os componentes